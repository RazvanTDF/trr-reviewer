<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TRR — Tutor, Reviewer & Refactor (Web MVP)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- js-yaml for guidelines YAML -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>

  <!-- highlight.js (core + languages) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/typescript.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/java.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/c.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/cpp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/go.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/csharp.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/php.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/ruby.min.js"></script>

  <style>
    :root { color-scheme: light dark; }
    .card { border-radius: 1rem; box-shadow: 0 12px 32px rgba(0,0,0,.10); }
    .badge { border-radius: 9999px; padding: .25rem .6rem; font-weight: 600; }
  </style>
</head>
<body class="h-screen bg-gradient-to-br from-indigo-50 to-sky-50 dark:from-neutral-900 dark:to-neutral-950 text-neutral-900 dark:text-neutral-100">
  <div class="h-full flex flex-col">
    <!-- Header -->
    <header class="px-6 pt-5 pb-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-2xl sm:text-3xl font-extrabold tracking-tight">TRR — Tutor, Reviewer & Refactor</h1>
      </div>

      <div class="flex items-center gap-3">
        <span id="langBadge" class="badge text-sm bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-200 border border-indigo-300/50">Language: —</span>

        <!-- Language selector -->
        <label class="flex items-center gap-2 text-sm">
          <span class="text-neutral-500">Language</span>
          <select id="langSelect" class="px-2 py-1 rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900">
            <option value="auto" selected>Auto</option>
            <option value="py">Python</option>
            <option value="js">JavaScript</option>
            <option value="ts">TypeScript</option>
            <option value="java">Java</option>
            <option value="c">C</option>
            <option value="cpp">C++</option>
            <option value="go">Go</option>
            <option value="cs">C#</option>
            <option value="php">PHP</option>
            <option value="rb">Ruby</option>
          </select>
        </label>

        <label class="flex items-center gap-2 text-sm ml-2">
          <input id="skipIfShort" type="checkbox" class="w-4 h-4" checked>
          <span>Skip LLM if &lt;</span>
          <input id="skipLen" type="number" value="400" min="0"
                 class="w-20 px-2 py-1 rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900">
          <span>chars</span>
        </label>

        <label class="flex items-center gap-2 text-sm ml-2">
          <input id="useLLM" type="checkbox" class="w-4 h-4">
          <span>Use Local LLM (POST /review)</span>
        </label>

        <button id="btnApplyFixes" class="px-3 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700 text-sm">Apply auto-fixes</button>
        <button id="btnAnalyze" class="px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700">Analyze</button>
      </div>
    </header>

    <!-- Main 50/50 -->
    <main class="grow px-6 pb-6">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
        <!-- Left: Code -->
        <section class="card h-full bg-white/85 dark:bg-neutral-900/70 p-4 flex flex-col">
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-semibold">Paste your code</h2>
            <div class="text-sm text-neutral-500">
              <span id="charCount">0</span> chars
            </div>
          </div>

          <textarea id="code" class="w-full grow min-h-[40vh] font-mono text-sm p-3 rounded-lg bg-white dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-800"
                    placeholder="Paste code here..."></textarea>

          <!-- Upload code -->
          <div id="uploadBox"
               class="mt-3 rounded-lg border border-dashed border-neutral-300 dark:border-neutral-700 p-3 text-sm
                      bg-white/70 dark:bg-neutral-900/60">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="font-medium">OR upload your file</div>
                <div class="text-neutral-500">Drag & drop aici sau alege un fișier (.py, .js, .ts, .java, .c, .cpp, .txt)</div>
              </div>
              <label class="px-3 py-1.5 rounded-md bg-neutral-100 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 cursor-pointer">
                Choose file
                <input id="fileInput" type="file" class="hidden" accept=".py,.js,.ts,.java,.c,.cpp,.txt,.md,.json,.yml,.yaml,.html,.css" />
              </label>
            </div>
          </div>

          <!-- Upload guidelines -->
          <div id="guidelineBox"
               class="mt-3 rounded-lg border border-dashed border-neutral-300 dark:border-neutral-700 p-3 text-sm
                      bg-white/70 dark:bg-neutral-900/60">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="font-medium">OR upload your guidelines</div>
                <div class="text-neutral-500">JSON/YAML (lang + pattern + message [+ replacement], target: suggestion|fix)</div>
                <div class="mt-1 text-xs">
                  Loaded rules: <span id="guidelineCount">0</span>
                </div>
              </div>
              <label class="px-3 py-1.5 rounded-md bg-neutral-100 dark:bg-neutral-800 border border-neutral-300 dark:border-neutral-700 cursor-pointer">
                Choose file
                <input id="guidelineInput" type="file" class="hidden" accept=".json,.yaml,.yml" />
              </label>
            </div>
          </div>

          <details class="mt-3">
            <summary class="cursor-pointer text-sm text-neutral-500">Preview</summary>
            <pre class="mt-2 rounded-lg overflow-auto max-h-[30vh]"><code id="hl" class="hljs"></code></pre>
          </details>
        </section>

        <!-- Right: Findings -->
        <section class="card h-full bg-white/85 dark:bg-neutral-900/70 p-4 flex flex-col">
          <div class="flex items-center justify-between mb-3">
            <h2 class="font-semibold">Findings</h2>
            <div class="text-sm text-neutral-500">
              <span id="fixCount">0</span> fixes · <span id="sugCount">0</span> suggestions
            </div>
          </div>

          <div id="summary" class="text-sm text-neutral-600 dark:text-neutral-300 mb-3"></div>

          <!-- Metrics (simple, sigur) -->
          <div id="metrics" class="mb-4 grid grid-cols-2 gap-2 text-sm text-neutral-700 dark:text-neutral-300">
            <div class="p-2 rounded-lg border border-neutral-200 dark:border-neutral-800 bg-neutral-50/70 dark:bg-neutral-900/30">
              <div class="font-semibold text-neutral-800 dark:text-neutral-100">LLM Tokens Used</div>
              <div id="metricTokens" class="text-lg font-mono text-indigo-600 dark:text-indigo-300">—</div>
            </div>
            <div class="p-2 rounded-lg border border-neutral-200 dark:border-neutral-800 bg-neutral-50/70 dark:bg-neutral-900/30">
              <div class="font-semibold text-neutral-800 dark:text-neutral-100">Estimated Cost</div>
              <div id="metricCost" class="text-lg font-mono text-emerald-600 dark:text-emerald-300">—</div>
            </div>
          </div>

          <div class="overflow-auto grow pr-1">
            <h3 class="font-semibold mb-1">Fixes</h3>
            <ul id="fixes" class="space-y-2 mb-4"></ul>

            <h3 class="font-semibold mb-1">Suggestions</h3>
            <ul id="suggestions" class="space-y-2"></ul>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // ===== Elements
    const ta = document.getElementById('code');
    const charCount = document.getElementById('charCount');
    const btnAnalyze = document.getElementById('btnAnalyze');
    const btnApplyFixes = document.getElementById('btnApplyFixes');
    const useLLM = document.getElementById('useLLM');
    const langBadge = document.getElementById('langBadge');
    const fixesList = document.getElementById('fixes');
    const suggestionsList = document.getElementById('suggestions');
    const fixCount = document.getElementById('fixCount');
    const sugCount = document.getElementById('sugCount');
    const summary = document.getElementById('summary');
    const hl = document.getElementById('hl');
    const langSelect = document.getElementById('langSelect');
    const fileInput = document.getElementById('fileInput');
    const uploadBox = document.getElementById('uploadBox');
    const guidelineInput = document.getElementById('guidelineInput');
    const guidelineBox   = document.getElementById('guidelineBox');
    const guidelineCount = document.getElementById('guidelineCount');
    const skipIfShort = document.getElementById('skipIfShort');
    const skipLen = document.getElementById('skipLen');
    let currentLang = "—"; // daca nu exista deja
    const threadState = {}; // cheie -> { msgs: [{who:'user'|'ai', text:string}, ...], item:{}, kind:'fix'|'sug' }
    function threadKey(kind, idx){ return `${kind}-${idx}`; }


    // Metrics (doar cele două câmpuri, fără alte ID-uri)
    const metricTokens = document.getElementById('metricTokens');
    const metricCost   = document.getElementById('metricCost');

    let customGuidelines = [];

    // ===== Helpers: metrics
    function clearMetrics() {
      metricTokens.textContent = '—';
      metricCost.textContent = '—';
    }
    function estimateTokens(chars) {
      // fallback safe: ~4 chars/token
      return Math.max(1, Math.round(chars / 4));
    }
    function renderMetricsFromLLM(mx, codeLen) {
      if (!mx || (mx.prompt_tokens_est == null && mx.response_tokens_est == null)) {
        // fallback pe lungime cod
        const t = estimateTokens(codeLen);
        metricTokens.textContent = String(t);
        metricCost.textContent = '—';
        return;
      }
      const t = (mx.prompt_tokens_est || 0) + (mx.response_tokens_est || 0);
      metricTokens.textContent = String(t);
      const cost = (mx.cost_usd_est != null) ? `$${mx.cost_usd_est}` : '—';
      metricCost.textContent = cost;
    }

    // ===== Helpers: guidelines
    function parseGuidelinesText(text, ext) {
      try {
        if (ext === 'yaml' || ext === 'yml') {
          if (typeof jsyaml === 'undefined') throw new Error('YAML support missing');
          return jsyaml.load(text);
        }
        return JSON.parse(text);
      } catch (e) {
        console.error(e);
        alert('Could not parse guidelines. Ensure JSON/YAML is valid.');
        return null;
      }
    }
    function normalizeAndCompileGuidelines(raw) {
      if (!Array.isArray(raw)) {
        alert('Guidelines must be an array of rule objects.');
        return [];
      }
      const out = [];
      for (const r of raw) {
        const lang = (r.lang || 'any').toLowerCase();
        const pattern = r.pattern;
        const flags = r.flags || 'g';
        const message = r.message || 'Guideline match';
        const target = (r.target || 'suggestion').toLowerCase();
        const replacement = r.replacement || null;
        if (!pattern) continue;
        let regex = null;
        try { regex = new RegExp(pattern, flags); } catch { continue; }
        out.push({ lang, regex, message, target, replacement });
      }
      return out;
    }
    function readFileAsText(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result || "");
        fr.onerror = reject;
        fr.readAsText(file);
      });
    }
    async function loadGuidelinesFromFile(file) {
      const ext = (file.name.split('.').pop() || '').toLowerCase();
      const text = await readFileAsText(file);
      const data = parseGuidelinesText(text, ext);
      if (!data) return;
      customGuidelines = normalizeAndCompileGuidelines(data);
      guidelineCount.textContent = String(customGuidelines.length);
      alert(`Loaded ${customGuidelines.length} guideline rule(s).`);
    }

    // ===== Stats
    function updateStats(){ charCount.textContent = ta.value.length; }
    ta.addEventListener('input', () => { updateStats(); highlightPreview(); });
    langSelect.addEventListener('change', ()=> { highlightPreview(); });

    // ===== Language detection (Auto + heuristici pentru fragmente scurte)
    function detectLanguage(code) {
      // override manual
      const forced = (langSelect.value || 'auto').toLowerCase();
      if (forced !== 'auto') return forced;

      const src = code || '';
      const trimmed = src.trim();

      // inline hint: "# lang: py", "// lang: js", etc
      const m = trimmed.match(/^\s*(?:#|\/\/|;|--)\s*lang:\s*([a-z+#]+)\b/i);
      if (m) {
        const v = m[1].toLowerCase();
        const alias = { python:'py', py:'py', js:'js', javascript:'js', ts:'ts', typescript:'ts', java:'java', c:'c', 'c++':'cpp', cpp:'cpp', go:'go', cs:'cs', csharp:'cs', php:'php', rb:'rb', ruby:'rb' };
        if (alias[v]) return alias[v];
      }

      // fragmente scurte: scor cuvinte-cheie
      if (trimmed.length < 40 || trimmed.split(/\s+/).length < 6) {
        const signals = {
          py:  [/\bdef\b/, /\bprint\(/, /\bclass\b/, /\bexcept\b/, /\bimport\b/],
          js:  [/\bfunction\b/, /\bconsole\.log\b/, /\blet\b/, /\bconst\b/, /=>/],
          ts:  [/\binterface\b/, /\bas\b/, /\b:\s*[\w\[\]<>]+\s*[=,)]/, /\bprivate\b/],
          java:[/\bpublic\s+(class|static)\b/, /\bSystem\.out\.println\b/, /\bnew\s+\w+\(/],
          c:   [/#include\s*<\w+>/, /\bprintf\(/, /\bint\s+main\s*\(/],
          cpp: [/#include\s*<\w+>/, /\bstd::\w+/, /\bcout\s*<</],
          go:  [/\bpackage\s+\w+/, /\bfunc\s+\w+\(/, /\bfmt\.Print/],
          cs:  [/\busing\s+\w+;/, /\bConsole\.WriteLine\b/, /\bnamespace\b/],
          php: [/^<\?php/, /\becho\s+["']/],
          rb:  [/\bdef\b/, /\bend\b/, /\bputs\b/],
        };
        const score = {};
        for (const k of Object.keys(signals)) {
          score[k] = signals[k].reduce((acc, re)=> acc + (re.test(trimmed) ? 1 : 0), 0);
        }
        const best = Object.entries(score).sort((a,b)=> b[1]-a[1])[0];
        if (best && best[1] >= 1) return best[0];
      }

      // highlight.js fallback
      try {
        const res = hljs.highlightAuto(src);
        let lang = (res.language || 'text').toLowerCase();
        // anti false-positive HTML/CSS -> Python
        if ((lang === 'xml' || lang === 'html' || lang === 'css') &&
            /\b(def |class |import |print\(|except|try:)/.test(src)) {
          return 'py';
        }
        const aliases = {
          javascript:'js', typescript:'ts', python:'py', java:'java',
          c:'c', cpp:'cpp', csharp:'cs', go:'go', php:'php', ruby:'rb'
        };
        return aliases[lang] || 'text';
      } catch { return 'text'; }
    }

    function setLangBadge(lang){
      langBadge.textContent = `Language: ${lang}`;
      langBadge.className = "badge text-sm";
      const isCode = (['py','js','ts','java','go','cs','c','cpp'].includes(lang));
      if (isCode) langBadge.className += " bg-emerald-100 text-emerald-800 dark:bg-emerald-900/40 dark:text-emerald-200 border border-emerald-300/40";
      else langBadge.className += " bg-indigo-100 text-indigo-800 dark:bg-indigo-900/50 dark:text-indigo-200 border border-indigo-300/50";
    }

    // ===== Generic heuristics
    function analyzeGeneric(code){
      const fixes = [];
      const suggestions = [];
      const lines = code.split(/\r?\n/);
      lines.forEach((l,i)=>{ if (l.length > 120) suggestions.push({ line:i+1, text:"Line exceeds 120 chars; consider wrapping.", src:"Rule" }); });
      lines.forEach((l,i)=>{ if (/TODO|FIXME/.test(l)) suggestions.push({ line:i+1, text:"Resolve TODO/FIXME or create a tracked issue.", src:"Rule" }); });
      return { fixes, suggestions };
    }

    // ===== Per-language analyzers
    function analyzeJS(code){
      const fixes = [], suggestions = [];
      const lines = code.split(/\r?\n/);
      lines.forEach((line,i)=>{
        if (/^\s*var\s+/.test(line)) fixes.push({ line:i+1, title:"Replace 'var' with 'let'", src:"Rule" });
        if (/(^|[^=])==([^=]|$)/.test(line)) suggestions.push({ line:i+1, text:"Use strict equality '===' unless coercion is required.", src:"Rule" });
        if (/\bconsole\.log\(/.test(line)) suggestions.push({ line:i+1, text:"Guard console.log behind a debug flag or remove.", src:"Rule" });
      });
      if (/\bawait\b/.test(code) && !/try\s*{[\s\S]*await[\s\S]*}\s*catch/.test(code)) {
        suggestions.push({ line:0, text:"Wrap awaits in try/catch to handle errors.", src:"Rule" });
      }
      return { fixes, suggestions };
    }
    function analyzePY(code){
      const fixes = [], suggestions = [];
      const lines = code.split(/\r?\n/);
      lines.forEach((l,i)=>{ if (/^\s*except\s*:\s*$/.test(l)) fixes.push({ line:i+1, title:"Replace bare `except:` with `except Exception:`", src:"Rule" }); });
      if (code.includes("open(") && !/with\s+open\(.+\)\s+as\s+\w+\s*:/.test(code)) suggestions.push({ line:0, text:"Use `with open(...) as f:` to avoid leaks.", src:"Rule" });
      if (/\brequests\.(get|post|put|delete|patch|head)\(/.test(code) && !/timeout\s*=/.test(code)) suggestions.push({ line:0, text:"Provide a `timeout=` in requests calls.", src:"Rule" });
      if (/\bfor\s+\w+\s+in\s+range\(\s*len\(.+\)\s*\)\s*:/.test(code)) suggestions.push({ line:0, text:"Prefer `for i, item in enumerate(seq):` over `range(len(seq)`.", src:"Rule" });
      if (/print\(\s*".*"\s*\+\s*/.test(code)) suggestions.push({ line:0, text:"Prefer f-strings over string concatenation.", src:"Rule" });
      if (/url\s*=\s*["']https?:\/\/[^"']+["']\s*\+\s*\w+/.test(code)) suggestions.push({ line:0, text:"Build URLs with f-strings or urllib.parse; avoid string concatenation.", src:"Rule" });
      if (/json\.loads\(\s*\w+\.text\s*\)/.test(code)) suggestions.push({ line:0, text:"Use `response.json()` instead of `json.loads(response.text)`.", src:"Rule" });
      if (/if\s+\w+\.status_code\s*==\s*200:/.test(code) && /else/.test(code) && !/raise/.test(code)) suggestions.push({ line:0, text:"Consider raising for non-200 responses or returning a structured error.", src:"Rule" });
      return { fixes, suggestions };
    }
    function analyzeJAVA(code){
      const fixes = [], suggestions = [];
      const lines = code.split(/\r?\n/);
      lines.forEach((l,i)=>{
        if (/\b\w+\s*==\s*".*?"/.test(l) || /".*?"\s*==\s*\w+/.test(l)) {
          suggestions.push({ line:i+1, text:"Use .equals(...) for string comparison.", src:"Rule" });
        }
      });
      if (/SELECT\s+.+\+\s*\w+/.test(code) || /WHERE\s+.+\+\s*\w+/.test(code)) {
        suggestions.push({ line:0, text:"Use PreparedStatement with placeholders; avoid SQL concatenation.", src:"Rule" });
      }
      if (/Connection\s+\w+\s*=\s*null|Statement\s+\w+\s*=\s*null|ResultSet\s+\w+\s*=\s*null/.test(code)) {
        suggestions.push({ line:0, text:"Use try-with-resources for JDBC objects to avoid leaks.", src:"Rule" });
      }
      if (/HttpClient\.newHttpClient\(\)/.test(code) && !/connectTimeout|Duration\.of/.test(code)) {
        suggestions.push({ line:0, text:"Set HttpClient timeouts (connect/read).", src:"Rule" });
      }
      if (/https?:\/\/[^\s"]+"\s*\+\s*\w+/.test(code)) {
        suggestions.push({ line:0, text:"Use URIBuilder/URLEncoder instead of string concatenation for URLs.", src:"Rule" });
      }
      if (/catch\s*\(\s*Exception\s+\w+\s*\)\s*\{[^}]*\}/.test(code) && !/log|printStackTrace/.test(code)) {
        suggestions.push({ line:0, text:"Improve exception handling: log stack trace or rethrow with context.", src:"Rule" });
      }
      return { fixes, suggestions };
    }
    function analyzeC(code){
      const fixes = [], suggestions = [];
      if (/\bstrcpy\s*\(|\bstrcat\s*\(/.test(code)) {
        suggestions.push({ line:0, text:"Avoid strcpy/strcat; use strncpy/strncat (or safer alternatives).", src:"Rule" });
      }
      if (/scanf\s*\(\s*"%s"\s*,/.test(code)) {
        suggestions.push({ line:0, text:'Unsafe scanf("%s"): add width limit like "%15s" or use fgets.', src:"Rule" });
      }
      if (/fopen\s*\(/.test(code) && !/fclose\s*\(/.test(code)) {
        suggestions.push({ line:0, text:"File opened with fopen() is not closed with fclose() (leak).", src:"Rule" });
      }
      if (/\bmalloc\s*\(/.test(code) && !/\bfree\s*\(/.test(code)) {
        suggestions.push({ line:0, text:"Allocation via malloc() is never freed (memory leak).", src:"Rule" });
      }
      if (/char\s+\w+\s*\[\s*\d+\s*\]\s*;/.test(code) && /strcpy|memcpy/.test(code)) {
        suggestions.push({ line:0, text:"Verify destination buffer size vs source length to avoid overflow.", src:"Rule" });
      }
      return { fixes, suggestions };
    }

    // ===== Analyzer dispatcher + guidelines
    function analyze(code, lang){
      const gen = analyzeGeneric(code);
      let spec = { fixes:[], suggestions:[] };
      if (lang === 'js' || lang === 'ts') spec = analyzeJS(code);
      else if (lang === 'py') spec = analyzePY(code);
      else if (lang === 'java') spec = analyzeJAVA(code);
      else if (lang === 'c' || lang === 'cpp') spec = analyzeC(code);

      const fixes = [...spec.fixes, ...gen.fixes];
      const suggestions = [...spec.suggestions, ...gen.suggestions];

      // guidelines
      try {
        for (const rule of customGuidelines) {
          if (!(rule && rule.regex)) continue;
          if (rule.lang !== 'any' && rule.lang !== lang) continue;
          if (rule.regex.test(code)) {
            if (rule.target === 'fix' && rule.replacement) {
              fixes.push({ line: null, title: `Guideline fix: ${rule.message}`, src: "Guideline" });
            } else {
              suggestions.push({ line: null, text: rule.message, src: "Guideline" });
            }
          }
          if (rule.regex.global) rule.regex.lastIndex = 0;
        }
      } catch (e) { console.error('Guideline evaluation error', e); }

      return { fixes, suggestions };
    }

    // ===== Merge LLM with base
    function mergeWithLLM(base, llmData){
      const seen = new Set();
      const fixes = [];
      const suggestions = [];
      function pushUnique(arr, item){
        const key = (item.title || item.text || item.message || "").toLowerCase().trim();
        if (!key || seen.has(key)) return;
        seen.add(key);
        arr.push(item);
      }
      base.fixes.forEach(f => pushUnique(fixes, f));
      base.suggestions.forEach(s => pushUnique(suggestions, s));
      (llmData.comments || []).forEach(c=>{
        const msg = String(c.message||'').trim();
        const mLow = msg.toLowerCase();
        if (!msg) return;
        if (mLow.includes('str.join') || mLow.includes('validate import') || mLow.includes('zip(items')) return;
        pushUnique(suggestions, { text: msg, line: (c.lineOffset||0), src:"AI" });
      });
      return { fixes, suggestions, summary: llmData.summary || "" };
    }

    // ===== Render
    function render({lang, fixes, suggestions, summaryText}){
      fixCount.textContent = fixes.length;
      sugCount.textContent = suggestions.length;
      summary.textContent = summaryText || `Language: ${lang}. ${fixes.length} fixes, ${suggestions.length} suggestions.`;

      fixesList.innerHTML = '';
      fixes.forEach(f=>{
        const li = document.createElement('li');
        li.className = "p-3 rounded-lg border border-emerald-200/60 dark:border-emerald-800/40 bg-emerald-50/50 dark:bg-emerald-900/20";
        const idx = fixesList.children.length;          // index vizual curent
        const key = threadKey('fix', idx);
threadState[key] = { msgs: [], item: { title: f.title || 'Fix', text: f.title, src: f.src || 'Rule' }, kind: 'fix' };

li.innerHTML = `
  <div class="text-sm flex items-start justify-between gap-2">
    <div>
      <span class="font-semibold">Fix:</span> ${escapeHtml(f.title || 'Review')}
      ${f.line ? `<span class="text-neutral-500">(line ${f.line})</span>` : ''}
      <span class="ml-2 text-emerald-700 dark:text-emerald-300 text-xs font-semibold">${f.src || 'Rule'}</span>
      ${threadPanelHTML(key)}
    </div>
  </div>`;

        fixesList.appendChild(li);
      });

      suggestionsList.innerHTML = '';
      suggestions.forEach(s=>{
        const li = document.createElement('li');
        const idx = suggestionsList.children.length;    // index vizual curent
        const key = threadKey('sug', idx);
        threadState[key] = { msgs: [], item: { text: s.text || s.message || 'Suggestion', src: s.src || 'Rule' }, kind: 'sug' };
        li.className = "p-3 rounded-lg border border-neutral-200 dark:border-neutral-800";
        li.innerHTML = `
          <div class="text-sm flex items-start justify-between gap-2">
    <div>
      <span class="font-semibold">Suggestion:</span> ${escapeHtml(s.text || s.message || '')}
      ${s.line ? `<span class="text-neutral-500">(line ${s.line})</span>` : ''}
      <span class="ml-2 ${s.src==='AI' ? 'text-indigo-700 dark:text-indigo-300' : 'text-emerald-700 dark:text-emerald-300'} text-xs font-semibold">${s.src || 'Rule'}</span>
      ${threadPanelHTML(key)}
    </div>
  </div>`;
        suggestionsList.appendChild(li);
      });
    }

    // ===== Preview
    function highlightPreview(){
      const code = ta.value;
      const lang = detectLanguage(code);
      setLangBadge(lang);
      try {
        const mapped = (
          lang==='js' ? 'javascript' :
          lang==='ts' ? 'typescript' :
          lang==='py' ? 'python' :
          lang==='java' ? 'java' :
          lang==='c' ? 'c' :
          lang==='cpp' ? 'cpp' :
          lang==='go' ? 'go' :
          lang==='cs' ? 'csharp' :
          lang==='php' ? 'php' :
          lang==='rb' ? 'ruby' : 'plaintext'
        );
        const res = hljs.highlight(code, { language: mapped });
        hl.innerHTML = res.value;
      } catch { hl.textContent = code; }
    }

    // ===== Auto-fix rules
    const autoFixers = {
      py: [
        { regex: /^\s*except\s*:\s*$/gm, replacement: "except Exception:", label: "Replace bare except" },
        { regex: /print\("(\w+)=["']?\s*"\s*\+\s*str\((.+?)\)\)/g, replacement: 'print(f"$1={$2}")', label: "Concat print -> f-string" }
      ],
      js: [
        { regex: /\bvar\b/g, replacement: "let", label: "var -> let" },
        { regex: /([^=!])==([^=])/g, replacement: "$1===$2", label: "== -> ===" }
      ],
      ts: [
        { regex: /\bvar\b/g, replacement: "let", label: "var -> let" },
        { regex: /([^=!])==([^=])/g, replacement: "$1===$2", label: "== -> ===" }
      ],
      java: [
        { regex: /(\w+)\s*==\s*"([^"]*)"/g, replacement: '$1.equals("$2")', label: 'Use ".equals" for strings' }
      ],
      c: [
        { regex: /\bstrcpy\s*\(/g, replacement: "strncpy(", label: "strcpy -> strncpy" },
        { regex: /scanf\s*\(\s*"%s"/g, replacement: 'scanf("%15s"', label: 'scanf("%s") -> "%15s"' }
      ],
      cpp: [
        { regex: /\bstrcpy\s*\(/g, replacement: "strncpy(", label: "strcpy -> strncpy" },
        { regex: /scanf\s*\(\s*"%s"/g, replacement: 'scanf("%15s"', label: 'scanf("%s") -> "%15s"' }
      ]
    };

    // Python auto-fix motor (extins) — cu listă de operații
    function toFStringSimple(_, key, expr) { return `print(f"${key}={${expr}}")`; }
    function applyPythonFixes(src) {
      let code = src, applied = 0;
      const ops = [];

      // bare except
      code = code.replace(/^\s*except\s*:\s*$/gm, ()=>{ applied++; ops.push("Replace bare `except:` with `except Exception:`"); return "except Exception:"; });

      // requests.* -> add timeout=10 dacă lipsește
      ["get","post","put","delete","patch","head"].forEach(m=>{
        const re = new RegExp(`\\brequests\\.${m}\\(([^)]*?)\\)`, "g");
        code = code.replace(re, (full, inside)=>{
          if (/timeout\s*=/.test(inside)) return full;
          applied++; ops.push(`Add timeout=10 to requests.${m}()`);
          const sep = inside.trim() ? inside.trim() + ", " : "";
          return `requests.${m}(${sep}timeout=10)`;
        });
      });

      // json.loads(resp.text) -> resp.json()
      code = code.replace(/\bjson\.loads\(\s*([a-zA-Z_]\w*)\.text\s*\)/g, (_, r)=>{ applied++; ops.push("Use response.json() instead of json.loads(response.text)"); return `${r}.json()`; });

      // print concat -> f-strings
      code = code.replace(/print\(\s*["']([A-Za-z0-9_]+)=["']\s*\+\s*str\((.+?)\)\s*\)/g, (m,k,ex)=>{ applied++; ops.push("Convert print concat to f-string"); return toFStringSimple(m,k,ex); });
      code = code.replace(/print\(\s*["']([^"']*?)["']\s*\+\s*str\((.+?)\)\s*\)/g, (m,prefix,ex)=>{ applied++; ops.push("Convert print concat to f-string"); return `print(f"${prefix}{${ex}}")`; });

      // open/read/close -> with open
      code = code.replace(
        /(^|\n)([ \t]*)f\s*=\s*open\(\s*([^\)]+)\s*\)\s*[\r]?\n\2([A-Za-z_]\w*)\s*=\s*f\.read\(\)\s*[\r]?\n\2f\.close\(\)/g,
        (m, nl, indent, openArgs, varName) => {
          applied++; ops.push("Use context manager `with open(...)`");
          const i = indent || "";
          return `${nl}${i}with open(${openArgs}) as f:\n${i}    ${varName} = f.read()`;
        }
      );

      // add main guard
      if (/^\s*def\s+main\s*\(/m.test(code) && !/if\s+__name__\s*==\s*["']__main__["']\s*:\s*\n\s*main\(\)/m.test(code)) {
        applied++; ops.push('Add `if __name__ == "__main__": main()` guard');
        code = code.replace(/\s*$/, `

if __name__ == "__main__":
    main()
`);
      }
      return { code, applied, ops };
    }

    // ===== Apply auto-fixes
    btnApplyFixes.addEventListener('click', ()=>{
      const original = ta.value;
      const lang = detectLanguage(original);
      currentLang = lang;   
      let code = original;
      let applied = 0;
      const ops = [];

      if (lang === 'py') {
        const res = applyPythonFixes(code);
        code = res.code; applied += res.applied;
        res.ops.forEach(t => ops.push({ title: `AUTO: ${t}`, src: "AutoFix" }));
      }

      // guideline fixes cu replacement
      for (const rule of customGuidelines) {
        if (!(rule && rule.regex && rule.replacement)) continue;
        if (rule.lang !== 'any' && rule.lang !== lang) continue;
        if (rule.target !== 'fix') continue;
        const before = code;
        try { code = code.replace(rule.regex, rule.replacement); } catch {}
        if (code !== before) { applied++; ops.push({ title: `AUTO: ${rule.message}`, src: "Guideline" }); }
      }

      // reguli generice (per limbaj)
      const rules = autoFixers[lang] || [];
      rules.forEach(rule=>{
        const before = code;
        code = code.replace(rule.regex, rule.replacement);
        if (code !== before) { applied++; ops.push({ title: `AUTO: ${rule.label || 'Fix'}`, src: "AutoFix" }); }
      });

      if (applied > 0) {
        ta.value = code;
        updateStats();
        highlightPreview();

        const base = analyze(code, lang);
        const fixesToShow = [
          ...ops.map(o => ({ title: o.title, line: null, src: o.src })),
          ...base.fixes
        ];
        const summaryText = `Language: ${lang}. Applied ${applied} auto-fix${applied>1?'es':''}.`;
        render({ lang, fixes: fixesToShow, suggestions: base.suggestions, summaryText });
        alert(`Applied ${applied} auto-fix${applied>1?'es':''} for ${lang}`);
      } else {
        alert("No matching issues found to fix automatically.");
      }
    });

    // ===== Analyze (heuristici + optional LLM)
    btnAnalyze.addEventListener('click', async ()=>{
      const code = ta.value;
      const lang = detectLanguage(code);
      currentLang = lang; 
      setLangBadge(lang);

      const base = analyze(code, lang);

      // fără LLM
      if (!useLLM.checked || (skipIfShort.checked && code.length < Number(skipLen.value || 0))) {
        render({ lang, fixes: base.fixes, suggestions: base.suggestions,
                 summaryText: `Language: ${lang}. ${base.fixes.length} fixes, ${base.suggestions.length} suggestions.` });
        clearMetrics();
        highlightPreview();
        return;
      }

      // cu LLM
      let llmData = { summary: "LLM offline", comments: [], metrics: null };
      try {
        const resp = await fetch('http://localhost:5143/review', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ code, lang, path: 'pasted' })
        });
        llmData = await resp.json();
      } catch {
        // lasă fallback
      }

      const merged = mergeWithLLM(base, llmData);
      const summaryText = `Language: ${lang}. ${base.fixes.length} fixes, ${base.suggestions.length} suggestions. | LLM: ${merged.summary || 'ok'}`;
      render({ lang, fixes: merged.fixes, suggestions: merged.suggestions, summaryText });

      // metrics safe
      renderMetricsFromLLM(llmData.metrics, code.length);

      highlightPreview();
    });

    // ===== Upload code (click & DnD)
    async function loadCodeFromFile(file) {
      const text = await readFileAsText(file);
      ta.value = text;
      updateStats();
      highlightPreview();
      const detected = detectLanguage(text);
      currentLang = detected;
      setLangBadge(detected);
    }
    fileInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try { await loadCodeFromFile(f); } catch { alert("Could not read file as text."); }
      finally { fileInput.value = ""; }
    });
    ;['dragenter','dragover'].forEach(ev =>
      uploadBox.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        uploadBox.classList.add('ring-2','ring-indigo-400');
      })
    );
    ;['dragleave','drop'].forEach(ev =>
      uploadBox.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        uploadBox.classList.remove('ring-2','ring-indigo-400');
      })
    );
    uploadBox.addEventListener('drop', async (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      try { await loadCodeFromFile(f); } catch { alert("Could not read file as text."); }
    });

    // ===== Upload guidelines (click & DnD)
    guidelineInput.addEventListener('change', async (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      try { await loadGuidelinesFromFile(f); } catch { alert("Could not read guideline file."); }
      finally { guidelineInput.value = ""; }
    });
    ;['dragenter','dragover'].forEach(ev =>
      guidelineBox.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        guidelineBox.classList.add('ring-2','ring-indigo-400');
      })
    );
    ;['dragleave','drop'].forEach(ev =>
      guidelineBox.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        guidelineBox.classList.remove('ring-2','ring-indigo-400');
      })
    );
    guidelineBox.addEventListener('drop', async (e) => {
      const f = e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0];
      if (!f) return;
      try { await loadGuidelinesFromFile(f); } catch { alert("Could not read guideline file."); }
    });

    // ===== Utils + init
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m])); }
    updateStats(); setLangBadge('—'); highlightPreview();

    function threadPanelHTML(key){
  return `
  <details class="mt-2 group" data-thread="${key}">
    <summary class="cursor-pointer text-xs text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-200">
      Discuss
      <span class="ml-2 text-[10px] px-1.5 py-0.5 rounded bg-neutral-100 dark:bg-neutral-800 border border-neutral-300/50 dark:border-neutral-700/50">
        open thread
      </span>
    </summary>
    <div class="mt-2 space-y-2">
      <div class="text-xs text-neutral-500">Conversation with reviewer</div>
      <div class="space-y-2" id="msgs-${key}"></div>
      <div class="flex gap-2">
        <input id="in-${key}" class="flex-1 px-2 py-1 rounded-md border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 text-sm"
               placeholder="Say why you disagree or ask for changes">
        <button class="text-xs px-2 py-1 rounded-md border border-neutral-300 dark:border-neutral-700" data-action="ask" data-key="${key}">Ask LLM</button>
        <button class="text-xs px-2 py-1 rounded-md border border-neutral-300 dark:border-neutral-700" data-action="agree" data-key="${key}">Agree</button>
        <button class="text-xs px-2 py-1 rounded-md border border-neutral-300 dark:border-neutral-700" data-action="disagree" data-key="${key}">Disagree</button>
      </div>
    </div>
  </details>`;
}

function appendMsg(key, who, text){
  const box = document.getElementById(`msgs-${key}`);
  if (!box) return;
  const div = document.createElement('div');
  div.className = `text-sm p-2 rounded-lg border ${who==='ai' ? 'border-indigo-200 dark:border-indigo-800 bg-indigo-50/50 dark:bg-indigo-900/20' : 'border-neutral-200 dark:border-neutral-800'}`;
  div.innerHTML = `<span class="text-xs uppercase font-semibold mr-2 ${who==='ai'?'text-indigo-700 dark:text-indigo-300':'text-neutral-500'}">${who}</span>${escapeHtml(text)}`;
  box.appendChild(div);
  box.scrollTop = box.scrollHeight;
}
  document.addEventListener('click', async (e)=>{
  const btn = e.target.closest('button[data-action]');
  if (!btn) return;

  const action = btn.getAttribute('data-action');
  const key = btn.getAttribute('data-key');
  if (!action || !key) return;

  const input = document.getElementById(`in-${key}`);
  const userNote = input ? input.value.trim() : '';
  const st = threadState[key];
  if (!st) return;

  // mereu retinem ultimul mesaj user
  if (userNote) appendMsg(key, 'user', userNote);

  if (action === 'ask') {
    // apel /explain
    try {
      const payload = {
        lang: currentLang || detectLanguage(ta.value),
        code: ta.value,
        message: (st.item.text || st.item.title || 'Finding') + (userNote ? ` | User: ${userNote}` : '')
      };
      const r = await fetch('http://127.0.0.1:5143/explain', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await r.json();
      appendMsg(key, 'ai', data.explanation || 'No explanation available.');
    } catch {
      appendMsg(key, 'ai', 'Explain failed (API offline?).');
    }
  }

  if (action === 'agree' || action === 'disagree') {
    // apel /feedback
    try {
      const payload = {
        lang: currentLang || detectLanguage(ta.value),
        message: st.item.text || st.item.title || 'Finding',
        code: ta.value,
        rule_source: st.item.src || 'Unknown',
        rule_id: null,
        user_note: userNote,
        action: action === 'agree' ? 'helpful' : 'disagree'
      };
      await fetch('http://127.0.0.1:5143/feedback', {
        method:'POST', headers:{'content-type':'application/json'},
        body: JSON.stringify(payload)
      });
      appendMsg(key, 'ai', action === 'agree' ? 'Thanks for confirming this was helpful.' : 'Thanks, your disagreement was recorded.');
    } catch {
      appendMsg(key, 'ai', 'Feedback failed (API offline?).');
    }
  }

  // curata inputul
  if (input) input.value = '';
});


  </script>
</body>
</html>
